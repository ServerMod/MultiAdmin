name: MultiAdmin Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:
  create:

jobs:
  build:
    name: .NET ${{matrix.framework}} on ${{matrix.os}}
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-20.04, windows-latest]
        framework: ['7.0']
        include:
        - os: ubuntu-20.04
          target: linux-x64
        - os: windows-latest
          target: win-x64
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3

    - if: matrix.os == 'ubuntu-20.04'
      name: Set up Linux dependencies
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: clang zlib1g-dev libkrb5-dev libtinfo5
        # Increment to invalidate the cache
        version: 1.0
        # Enables a workaround to attempt to run pre and post install scripts
        execute_install_scripts: true
        # Disables uploading logs as a build artifact
        debug: false

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{matrix.framework}}

    - name: Restore for ${{matrix.target}}
      run: dotnet restore -r ${{matrix.target}}

    - name: Publish for ${{matrix.target}}
      run: dotnet publish -r ${{matrix.target}} -c Release -o "${{github.workspace}}/Builds/${{matrix.framework}}/${{matrix.target}}" "MultiAdmin"

    - name: Run unit tests
      run: dotnet test

    - name: Upload ${{matrix.target}} build
      uses: actions/upload-artifact@v3
      with:
        name: MultiAdmin-${{matrix.target}}-${{matrix.framework}}
        path: ${{github.workspace}}/Builds/${{matrix.framework}}/${{matrix.target}}

    - name: Upload ${{matrix.target}} build to bundle
      uses: actions/upload-artifact@v3
      with:
        name: MultiAdmin-all-${{matrix.framework}}
        path: ${{github.workspace}}/Builds/${{matrix.framework}}
